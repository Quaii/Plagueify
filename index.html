<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Plagueify — Refresh Token</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;800&display=swap" rel="stylesheet">
<style>
  :root{
    color-scheme:dark;
    --bg:#0b0b0c; --ink:#e8e8ea; --line:#2b2f36;
    --blue1:#6da5ff; --blue2:#3a6df5; --blue3:#4a82ff;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    background:var(--bg); color:var(--ink);
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden; cursor:none; /* we draw our own */
  }

  /* Frosted-glass + raindrops canvas (never intercepts clicks) */
  #bg{position:fixed; inset:0; width:100%; height:100%; display:block; z-index:0; pointer-events:none;}

  .stage{position:relative; z-index:1; height:100%; display:grid; place-items:center; padding:24px; overflow:visible;}
  .container{width:min(820px,92vw); opacity:0; transform:translateY(8px) scale(.985)}
  .in{animation:fadeIn .7s cubic-bezier(.2,.75,.2,1) .05s forwards}
  @keyframes fadeIn{to{opacity:1; transform:translateY(0) scale(1)}}

  /* Title */
  .title{
    font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    font-weight:800; letter-spacing:.2px;
    font-size:clamp(48px,10vw,98px);
    line-height:.95; user-select:none; text-align:center;
    margin:0 0 36px 0; white-space:nowrap; overflow:visible;
    text-shadow:0 0 10px rgba(90,140,255,.18); /* glow, not bloom */
  }
  .titleRow{display:inline-flex; align-items:baseline; gap:0; overflow:visible;}
  .blueGrad{
    background:linear-gradient(180deg,var(--blue1) 0%,var(--blue3) 50%,var(--blue2) 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    filter:drop-shadow(0 0 8px rgba(90,140,255,.18));
  }

  /* Suffix lane: fixed width = width of longest word so centering doesn't shift */
  .suffixLane{
    position:relative; display:inline-block; vertical-align:baseline;
    min-width:10px; /* measured & set at runtime */
  }
  .suffixText{ color:#fff; letter-spacing:0; display:inline; }
  .caret{
    display:inline-block; width:0.055em; height:0.95em; background:#fff;
    margin-left:6px; vertical-align:-0.05em;
  }
  @keyframes blink{0%,45%{opacity:1}55%,100%{opacity:.18}}
  .blink{animation:blink 950ms step-end infinite}
  @keyframes jiggle{0%{transform:translateY(0)}50%{transform:translateY(-1px)}100%{transform:translateY(0)}}

  /* Token UI */
  .block{width:min(700px,86vw); margin:0 auto}
  .label{font-weight:700; margin:0 0 8px 6px;}
  .token{
    width:100%; padding:12px 14px; background:#121317cc; color:var(--ink);
    border:1px solid var(--line); border-radius:0;
    font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.95rem;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    outline:none; backdrop-filter:blur(2px);
    transition:border-color .18s ease, transform .18s ease;
  }
  .token:focus{border-color:#3c68ff; transform:translateY(-1px)}

  .controls{text-align:center; margin-top:16px}
  .btn{
    appearance:none; border:1px solid var(--line); background:#1a1c21; color:var(--ink);
    padding:12px 18px; border-radius:0; font-weight:700; letter-spacing:.2px; cursor:pointer;
    transition:transform .12s, border-color .2s, box-shadow .2s, background .2s;
    box-shadow:0 12px 28px rgba(0,0,0,.28);
  }
  .btn:hover{ transform:translateY(-1px); border-color:#3a4050; background:#1f2228; box-shadow:0 16px 34px rgba(0,0,0,.36) }
  .hero{display:flex; flex-direction:column; align-items:center; gap:28px}
  .btn-cta{ padding:14px 22px }

  .hide{display:none !important}
  .muted{opacity:.72; font-size:.95rem; text-align:center; margin-top:10px}
  .ok{color:#9ae6a0} .err{color:#ff8c8c}

  /* Custom cursor — glow ring only */
  .cursorRing{
    position:fixed; left:50%; top:50%;
    width:42px; height:42px; border-radius:50%; pointer-events:none;
    z-index:9999; /* always above */
    border:1px solid rgba(120,165,255,.55);
    box-shadow:
      0 0 20px rgba(90,140,255,.35),
      inset 0 0 22px rgba(90,140,255,.25);
    transform:translate(-50%,-50%);
  }
</style>
</head>
<body>
  <!-- Frosted glass + raindrops -->
  <canvas id="bg" aria-hidden="true"></canvas>

  <!-- Custom glow cursor -->
  <div class="cursorRing" id="ring"></div>

  <div class="stage">
    <div class="container" id="container">
      <!-- Screen A -->
      <section id="screenA" class="hero">
        <h1 class="title" aria-live="polite">
          <span class="titleRow">
            <span class="blueGrad">Plague</span>
            <span class="suffixLane"><span id="suffix" class="suffixText"></span></span>
            <span id="caret" class="caret blink"></span>
          </span>
        </h1>
        <button class="btn btn-cta" id="btn-login">Sign in to Spotify</button>
        <div id="statusA" class="muted"></div>
      </section>

      <!-- Screen B -->
      <section id="screenB" class="hide">
        <h1 class="title">
          <span class="titleRow"><span class="blueGrad">Plague</span><span class="suffixText">ify</span></span>
        </h1>
        <div class="block">
          <p class="label">Your Token</p>
          <input id="tokenBox" class="token" type="text" readonly />
          <div class="controls"><button class="btn" id="btn-copy">Manual Copy</button></div>
          <div id="statusB" class="muted"></div>
        </div>
      </section>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('container').classList.add('in');

  /* ================= Frosted glass + glowing raindrops ================= */
  (function frosted(){
    const c = document.getElementById('bg');
    const ctx = c.getContext('2d');
    let w,h,dpr, drops=[];

    function resize(){
      w = innerWidth; h = innerHeight; dpr = Math.min(2, devicePixelRatio||1);
      c.style.width = w+'px'; c.style.height = h+'px';
      c.width = (w*dpr)|0; c.height = (h*dpr)|0;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      // rebuild drops
      const count = Math.floor((w*h)/38000); // scale with screen
      drops = new Array(count).fill(0).map(()=>spawn());
    }
    function spawn(){
      const r = 1 + Math.random()*2.2;
      return {
        x: Math.random()*w, y: Math.random()*h,
        r, vy: 0.3 + Math.random()*0.8, sway: (Math.random()-.5)*0.25,
        hue: 215 + Math.random()*18, alpha: 0.18 + Math.random()*0.25
      };
    }
    function drawGlass(){
      // soft frosted plate in center
      const g = ctx.createRadialGradient(w*0.5, h*0.45, Math.min(w,h)*0.1, w*0.5, h*0.45, Math.min(w,h)*0.6);
      g.addColorStop(0, '#0f141f');
      g.addColorStop(1, '#0b0b0c');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);
    }
    function draw(){
      drawGlass();
      ctx.globalCompositeOperation = 'lighter';
      for (const d of drops){
        d.y += d.vy; d.x += d.sway;
        if (d.y - d.r > h+10) { d.y = -10; d.x = Math.random()*w; }
        ctx.shadowColor = `hsla(${d.hue}, 80%, 60%, ${d.alpha})`;
        ctx.shadowBlur = 14;
        ctx.fillStyle = `hsla(${d.hue}, 80%, 60%, ${d.alpha*0.65})`;
        ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
      }
      ctx.shadowBlur = 0;
      ctx.globalCompositeOperation = 'source-over';
      requestAnimationFrame(draw);
    }
    resize(); addEventListener('resize', resize); draw();
  })();

  /* ================= Precise glow cursor (ring only) ================= */
  (function cursorRing(){
    const ring = document.getElementById('ring');
    let rx = innerWidth/2, ry = innerHeight/2, tx = rx, ty = ry;
    function move(e){ const t = e.touches?e.touches[0]:e; tx=t.clientX; ty=t.clientY; }
    addEventListener('pointermove', move, {passive:true});
    addEventListener('touchmove', move, {passive:true});
    (function tick(){
      rx += (tx - rx) * 0.18; ry += (ty - ry) * 0.18;
      ring.style.left = rx+'px'; ring.style.top = ry+'px';
      requestAnimationFrame(tick);
    })();
  })();

  /* ================= Typing (suffix only, anchored, smooth, loop) ================= */
  (function typing(){
    const suffixLane = document.querySelector('.suffixLane');
    const suffix = document.getElementById('suffix');
    const caret = document.getElementById('caret');

    // Measure max width using an offscreen span so center stays steady
    const measure = (text)=>{
      const s = document.createElement('span');
      s.style.visibility='hidden'; s.style.position='absolute'; s.style.whiteSpace='nowrap';
      s.className = 'suffixText';
      s.textContent = text;
      document.body.appendChild(s);
      const w = s.getBoundingClientRect().width;
      document.body.removeChild(s);
      return w;
    };
    const MAX_SUFFIX = 'cheat.cc'; // lowercase 'c' per spec
    suffixLane.style.minWidth = Math.ceil(measure(MAX_SUFFIX)) + 'px';

    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    async function type(text, cps){ // time-based
      const start = performance.now(); let i = 0;
      while (i < text.length){
        const elapsed = (performance.now()-start)/1000;
        const target = Math.floor(elapsed*cps);
        const next = Math.min(target, text.length);
        while (i < next){
          i++;
          suffix.textContent = text.slice(0,i);
          caret.style.animation='jiggle 120ms ease-out'; setTimeout(()=>caret.style.animation='',120);
        }
        await new Promise(r=>requestAnimationFrame(r));
      }
    }
    async function backspace(n, cps){
      for (let i=0;i<n;i++){
        suffix.textContent = suffix.textContent.slice(0,-1);
        caret.style.animation='jiggle 120ms ease-out'; setTimeout(()=>caret.style.animation='',120);
        await sleep(1000/cps);
      }
    }

    async function loop(){
      while(true){
        suffix.textContent = '';
        await type('cheat.cc', 7);     // slower
        await sleep(900);
        await backspace('cheat.cc'.length, 7); // slow erase
        await type('ify', 4);          // extra slow
        await sleep(1800);
        await backspace('ify'.length, 9);
        await sleep(500);
      }
    }
    loop();
  })();

  /* ================= OAuth (unchanged) ================= */
  const CLIENT_ID = "ec6dea15d2df46efbb5cc43de67768b3";
  const REDIRECT_URI = "https://quaii.github.io/Plagueify/";
  const SCOPES = "";

  const $ = id => document.getElementById(id);
  const screenA = $('screenA'), screenB = $('screenB');
  const statusA = $('statusA'), statusB = $('statusB');
  const btnLogin = $('btn-login'), btnCopy = $('btn-copy'), tokenBox = $('tokenBox');

  function randomId(){
    return Array(32).fill(0).map(()=>Math.random().toString(36)[2]||0).join('');
  }

  async function oauth(){
    const state = randomId();
    localStorage.setItem('oauth_state', state);
    const params = new URLSearchParams({
      response_type: 'token',
      client_id: CLIENT_ID,
      scope: SCOPES,
      redirect_uri: REDIRECT_URI,
      state,
      show_dialog: 'true'
    });
    window.location.href = `https://accounts.spotify.com/authorize?${params}`;
  }

  function parseUrl(){
    const frag = window.location.hash.substring(1);
    if (!frag) return {};
    const obj = {};
    for (const kv of frag.split('&')){
      const [k, v] = kv.split('=');
      if (k && v) obj[k] = decodeURIComponent(v);
    }
    return obj;
  }

  async function handleToken(){
    const { access_token, state, error } = parseUrl();
    if (error) {
      statusA.textContent = '🚫 Authorization failed.';
      statusA.className = 'muted err';
      return;
    }
    if (!access_token) return;

    const saved = localStorage.getItem('oauth_state');
    if (state !== saved) {
      statusA.textContent = '🚫 State mismatch.';
      statusA.className = 'muted err';
      return;
    }

    localStorage.removeItem('oauth_state');
    window.history.replaceState({}, document.title, window.location.pathname);

    // display token
    screenA.classList.add('hide');
    screenB.classList.remove('hide');
    tokenBox.value = access_token;

    statusB.textContent = '✅ Success! This token expires in 1 hour.';
    statusB.className = 'muted ok';
  }

  btnLogin.addEventListener('click', oauth);
  btnCopy.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(tokenBox.value);
      statusB.textContent = '📋 Copied to clipboard!';
      statusB.className = 'muted ok';
    } catch {
      tokenBox.select();
      statusB.textContent = '📋 Selected — press Ctrl+C to copy.';
      statusB.className = 'muted';
    }
  });

  handleToken();
});
</script>
</body>
</html>
